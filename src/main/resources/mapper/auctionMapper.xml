<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.gradationback.mapper.AuctionMapper">
    
    <insert id="insert" parameterType="AuctionVO">
        INSERT INTO TBL_AUCTION (
            ID,
            ART_ID,
            AUCTION_START_DATE,
            AUCTION_START_PRICE,
            AUCTION_ESTIMATED_MIN_PRICE,
            AUCTION_ESTIMATED_MAX_PRICE
        )
        VALUES (
            SEQ_AUCTION.NEXTVAL,
            #{artId},
            TO_DATE(#{auctionStartDate}, 'YYYY-MM-DD HH24:MI:SS'),
            #{auctionStartPrice},
            #{auctionEstimatedMinPrice},
            #{auctionEstimatedMaxPrice}
        )
    </insert>
    
    <select id="selectAll" resultType="AuctionDTO">
        SELECT
            TAU.ID,
            TAU.ART_ID,
            TAU.USER_ID,
            AUCTION_START_DATE,
            AUCTION_START_PRICE,
            AUCTION_ESTIMATED_MIN_PRICE,
            AUCTION_ESTIMATED_MAX_PRICE,
            AUCTION_ATTRACTED,
            AUCTION_BID_PRICE,
            AUCTION_BID_DATE,

            TAR.ID,
            ART_TITLE,
            ART_CATEGORY,
            ART_MATERIAL,
            ART_SIZE,
            ART_DESCRIPTION,
            ART_END_DATE,
            TAR.USER_ID,

            TAI.ART_IMG_NAME,
            TAI.ART_IMG_PATH

        FROM TBL_AUCTION TAU
        JOIN TBL_ART TAR
        ON TAU.ART_ID = TAR.ID
        LEFT JOIN (
            SELECT TAI1.ART_ID, TAI1.ART_IMG_NAME, TAI1.ART_IMG_PATH
            FROM TBL_ART_IMG TAI1
            JOIN (
                SELECT ART_ID, MIN(ID) AS MIN_ID
                FROM TBL_ART_IMG
                GROUP BY ART_ID
            ) TAI2
            ON TAI1.ART_ID = TAI2.ART_ID
            AND TAI1.ID = TAI2.MIN_ID
        ) TAI
        ON TAR.ID = TAI.ART_ID
    </select>

    <select id="select" resultType="AuctionDTO" parameterType="Long">
        SELECT
            TAU.ID,
            TAU.ART_ID,
            TAU.USER_ID,
            AUCTION_START_DATE,
            AUCTION_START_PRICE,
            AUCTION_ESTIMATED_MIN_PRICE,
            AUCTION_ESTIMATED_MAX_PRICE,
            AUCTION_ATTRACTED,
            AUCTION_BID_PRICE,
            AUCTION_BID_DATE,

            TAR.ID,
            ART_TITLE,
            ART_CATEGORY,
            ART_MATERIAL,
            ART_SIZE,
            ART_DESCRIPTION,
            ART_END_DATE,
            TAR.USER_ID,

            TAI.ART_IMG_NAME,
            TAI.ART_IMG_PATH

        FROM TBL_AUCTION TAU
                 JOIN HR.TBL_ART TAR ON TAU.ART_ID = TAR.ID
                 JOIN HR.TBL_ART_IMG TAI ON TAR.ID = TAI.ART_ID
        WHERE TAU.ID = #{id}
    </select>

    <update id="update" parameterType="AuctionVO">
        UPDATE TBL_AUCTION
        SET
            AUCTION_START_DATE = TO_DATE(#{auctionStartDate}, 'YYYY-MM-DD HH24:MI:SS'),
            AUCTION_START_PRICE = #{auctionStartPrice},
            AUCTION_ESTIMATED_MIN_PRICE = #{auctionEstimatedMinPrice},
            AUCTION_ESTIMATED_MAX_PRICE = #{auctionEstimatedMaxPrice},

            <choose>
                <when test="auctionAttracted">
                    AUCTION_ATTRACTED = 1,
                    USER_ID = #{userId},
                    AUCTION_BID_PRICE = #{auctionBidPrice}
                </when>
                <otherwise>
                    AUCTION_ATTRACTED = 0
                </otherwise>
            </choose>
            <choose>
                <when test="auctionBidDate != null">
                    ,AUCTION_BID_DATE = TO_DATE(#{auctionBidDate}, 'YYYY-MM-DD HH24:MI:SS')
                </when>
                <otherwise>
                </otherwise>
            </choose>
        WHERE ID = #{id}
    </update>

    <delete id="delete" parameterType="Long">
        DELETE FROM TBL_AUCTION
        WHERE ID = #{id}
    </delete>
</mapper>