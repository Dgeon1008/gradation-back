<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.gradationback.mapper.ExhibitionMapper">

    <!--    그라데이션 -->
<!--    전시회 정보 불러오기 -->
        <select id="selectGradation" resultType="GradationExhibitionVO">
            SELECT
                ID,
                GRADATION_EXHIBITION_TITLE,
                GRADATION_EXHIBITION_ART,
                GRADATION_EXHIBITION_CATEGORY,
                GRADATION_EXHIBITION_TIME,
                GRADATION_EXHIBITION_FEE,
                GRADATION_EXHIBITION_TEL,
                GRADATION_EXHIBITION_ADDRESS,
                GRADATION_EXHIBITION_DATE
            FROM (
                SELECT
                    ID,
                    GRADATION_EXHIBITION_TITLE,
                    GRADATION_EXHIBITION_ART,
                    GRADATION_EXHIBITION_CATEGORY,
                    GRADATION_EXHIBITION_TIME,
                    GRADATION_EXHIBITION_FEE,
                    GRADATION_EXHIBITION_TEL,
                    GRADATION_EXHIBITION_ADDRESS,
                    GRADATION_EXHIBITION_DATE
                FROM TBL_GRADATION_EXHIBITION
                ORDER BY ID DESC
            )
            WHERE ROWNUM = 1
        </select>

<!--        전시관 장소 이미지 리스트로 불러오기 -->
    <select id="selectGradationImgAll" parameterType="Long" resultType="GradationExhibitionImgVO">
        SELECT
            ID,
            GRADATION_EXHIBITION_IMG_NAME,
            GRADATION_EXHIBITION_IMG_PATH,
            GRADATION_EXHIBITION_ID
        FROM TBL_GRADATION_EXHIBITION_IMG
        WHERE GRADATION_EXHIBITION_ID = #{gradationExhibitionId}
        ORDER BY ID
    </select>

    <!--    전시회 등록 -->
    <insert id="insertGradation" parameterType="GradationExhibitionVO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT  SEQ_GRADATION_EXHIBITION.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_GRADATION_EXHIBITION (
        ID,
        GRADATION_EXHIBITION_TITLE,
        GRADATION_EXHIBITION_ART,
        GRADATION_EXHIBITION_CATEGORY,
        GRADATION_EXHIBITION_TIME,
        GRADATION_EXHIBITION_FEE,
        GRADATION_EXHIBITION_TEL,
        GRADATION_EXHIBITION_ADDRESS,
        GRADATION_EXHIBITION_DATE
        )
        VALUES (
        #{id},
        #{gradationExhibitionTitle},
        #{gradationExhibitionArt},
        #{gradationExhibitionCategory},
        #{gradationExhibitionTime},
        #{gradationExhibitionFee},
        #{gradationExhibitionTel},
        #{gradationExhibitionAddress},
        #{gradationExhibitionDate}
        )
    </insert>

    <!--    전시관 장소 이미지 추가 -->
    <insert id="insertGradationImg" parameterType="GradationExhibitionImgVO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT SEQ_GRADATION_EXHIBITION_IMG.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_GRADATION_EXHIBITION_IMG (
        ID,
        GRADATION_EXHIBITION_IMG_NAME,
        GRADATION_EXHIBITION_IMG_PATH,
        GRADATION_EXHIBITION_ID
        )
        VALUES (
        #{id},
        #{gradationExhibitionImgName},
        #{gradationExhibitionImgPath},
        #{gradationExhibitionId})
    </insert>

    <!--    전시회 정보 수정 -->
    <update id="updateGradation" parameterType="GradationExhibitionVO">
        UPDATE TBL_GRADATION_EXHIBITION
        SET GRADATION_EXHIBITION_TITLE = #{gradationExhibitionTitle},
            GRADATION_EXHIBITION_ART = #{gradationExhibitionArt},
            GRADATION_EXHIBITION_CATEGORY = #{gradationExhibitionCategory},
            GRADATION_EXHIBITION_TIME = #{gradationExhibitionTime},
            GRADATION_EXHIBITION_FEE = #{gradationExhibitionFee},
            GRADATION_EXHIBITION_TEL = #{gradationExhibitionTel},
            GRADATION_EXHIBITION_ADDRESS = #{gradationExhibitionAddress},
            GRADATION_EXHIBITION_DATE = #{gradationExhibitionDate}
        WHERE ID = #{id}
    </update>

    <!--    전시회 장소 이미지 삭제 -->
    <delete id="deleteGradationImg" parameterType="Long">
        DELETE FROM TBL_GRADATION_EXHIBITION_IMG
        WHERE ID = #{id}
    </delete>

<!--    최근 전시회 년도 + 제목 3개 List(올해 제외)  -->
    <select id="selectRecentGradations" resultType="GradationExhibitionVO">
        SELECT
            ID,
            GRADATION_EXHIBITION_TITLE,
            GRADATION_EXHIBITION_DATE
        FROM (
            SELECT
                ID,
                GRADATION_EXHIBITION_TITLE,
                GRADATION_EXHIBITION_DATE
            FROM TBL_GRADATION_EXHIBITION
            WHERE TO_NUMBER(SUBSTR(GRADATION_EXHIBITION_DATE, 1, 4)) &lt; TO_NUMBER(TO_CHAR(SYSDATE, 'YYYY'))
            ORDER BY TO_NUMBER(SUBSTR(GRADATION_EXHIBITION_DATE, 1, 4)) DESC
        )
        WHERE ROWNUM &lt;=3
    </select>

<!--   좋아요순 50개 작품 -->
    <select id="selectTopLikedArts" resultType="DisplayDTO">
        SELECT
            TAI.ART_IMG_NAME,
            TAI.ART_IMG_PATH,
            TAR.ART_TITLE,
            TU.USER_NAME,
            TAL.LIKE_COUNT
        FROM TBL_ART TAR
        JOIN (
            SELECT ART_ID, COUNT(ID) AS LIKE_COUNT
            FROM TBL_ART_LIKE
            WHERE EXTRACT(YEAR FROM ART_LIKE_TIME) = EXTRACT(YEAR FROM CURRENT_DATE)
            GROUP BY ART_ID
            ORDER BY LIKE_COUNT DESC
                FETCH NEXT 50 ROWS ONLY
        ) TAL
            ON TAR.ID = TAL.ART_ID
            JOIN (
                SELECT T1.ART_ID, T1.ART_IMG_NAME, T1.ART_IMG_PATH
                FROM TBL_ART_IMG T1
                JOIN (
                    SELECT ART_ID, MIN(ID) AS MIN_ID
                    FROM TBL_ART_IMG
                    GROUP BY ART_ID
                ) T2
                    ON T1.ART_ID = T2.ART_ID
                    AND T1.ID = T2.MIN_ID
            ) TAI
                ON TAR.ID = TAI.ART_ID
            JOIN TBL_USER TU
                ON TAR.USER_ID = TU.ID
    </select>



<!--    대학교 전시회 -->
<!--    신청 양식(학교) -->
    <insert id="insertUniversity" parameterType="UniversityExhibitionDTO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT SEQ_UNIVERSITY.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_UNIVERSITY(
            ID,
            UNIVERSITY_NAME,
            UNIVERSITY_LOGO_IMG_NAME,
            UNIVERSITY_LOGO_IMG_PATH,
            UNIVERSITY_HOMEPAGE
        )
        VALUES (
            #{id},
            #{universityName},
            #{universityLogoImgName},
            #{universityLogoImgPath},
            #{universityHomepage}
        )
    </insert>

<!--    신청 양식(학과) -->
    <insert id="insertMajor" parameterType="UniversityExhibitionDTO">
        <selectKey keyProperty="majorId" resultType="Long" order="BEFORE">
            SELECT SEQ_MAJOR.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_MAJOR (
            ID,
            UNIVERSITY_ID,
            MAJOR_NAME
        )
        VALUES (
            #{majorId},
            #{id},
            #{majorName}
        )
    </insert>

<!--    신청 양식(대학교 전시회) -->
    <insert id="insertUniversityExhibition" parameterType="UniversityExhibitionDTO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT SEQ_UNIVERSITY_EXHIBITION.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_UNIVERSITY_EXHIBITION(
            ID,
            UNIVERSITY_EXHIBITION_START_DATE,
            UNIVERSITY_EXHIBITION_END_DATE,
            UNIVERSITY_EXHIBITION_TITLE,
            UNIVERSITY_EXHIBITION_LOCATION,
            MAJOR_ID
        )
        VALUES (
            #{id},
            #{universityExhibitionStartDate},
            #{universityExhibitionEndDate},
            #{universityExhibitionTitle},
            #{universityExhibitionLocation},
            #{majorId}
        )
    </insert>
    
    <insert id="insertUniversityExhibitionImg" parameterType="UniversityExhibitionDTO" >
        INSERT INTO TBL_UNIVERSITY_EXHIBITION_IMG (
            ID,
            UNIVERSITY_EXHIBITION_IMG_NAME,
            UNIVERSITY_EXHIBITION_IMG_PATH,
            UNIVERSITY_EXHIBITION_ID
        )
        VALUES (
            SEQ_UNIVERSITY_EXHIBITION_IMG.NEXTVAL,
            #{universityExhibitionImgName},
            #{universityExhibitionImgPath},
            #{universityExhibitionId}
        )
    </insert>

<!--    로고 매칭을 위한 대학교 조회 -->
    <select id="findUniversityByName" resultType="UniversityVO" parameterType="Long">
        SELECT
            ID,
            UNIVERSITY_NAME,
            UNIVERSITY_LOGO_IMG_NAME,
            UNIVERSITY_LOGO_IMG_PATH,
            UNIVERSITY_HOMEPAGE
        FROM TBL_UNIVERSITY
        WHERE UNIVERSITY_NAME = #{universityName}
    </select>



</mapper>